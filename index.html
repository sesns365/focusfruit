<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´æœæ”¤å°ˆæ³¨åŠ›åœ“åœˆé…å° - å¸‚å ´åµæ¢</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®šå­—é«”èˆ‡æ•´é«”æ’ç‰ˆ */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh; /* ç¢ºä¿ä¸»é«”è‡³å°‘å¡«æ»¿è¦–çª—é«˜åº¦ */
            padding: 16px;
        }

        /* é¡è‰²åœ“åœˆæŒ‰éˆ•åŸºæœ¬æ¨£å¼ */
        .color-circle {
            flex-shrink: 0;
            width: 40px; /* ç•¥å¾®åŠ å¤§ */
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s, border 0.2s;
            border: 4px solid transparent; 
        }
        
        /* é¸ä¸­æ™‚çš„æ¨£å¼ (ç§»é™¤è—è‰²å…‰æšˆï¼Œåƒ…ä¿ç•™è—è‰²é‚Šæ¡†) */
        .color-circle.selected {
            transform: scale(1.1);
            border-color: #1d4ed8; 
        }

        /* ç­”æ¡ˆéŒ¯èª¤/æ­£ç¢ºæ¨£å¼ */
        .color-circle.error { border-color: #ef4444; box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.4); }
        .color-circle.correct { border-color: #10b981; box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.4); }

        /* æ”¤ä½è¤‡é›œåº¦æ¨£å¼ - ä½¿ç”¨ CSS æ¨¡æ“¬å®Œæ•´ä¸”è¤‡é›œçš„æ”¤è²©èƒŒæ™¯ */
        .busy-scene {
            position: relative;
            height: 100%; /* ç¢ºä¿å¡«æ»¿çˆ¶å®¹å™¨é«˜åº¦ */
            overflow: hidden; 
            background-color: #5d4037; 
        }
        
        /* ç¢ºä¿å·¦å³å…§å®¹å€å¡Šé«˜åº¦ä¸€è‡´ */
        #game-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            /* è®“ game-container ä½”æ“šæ•´å€‹é é¢å¯ç”¨çš„å‚ç›´ç©ºé–“ */
            flex-grow: 1; 
        }
        
        /* é‡å°å¤§è¢å¹•çš„ 2/3 vs 1/3 ä½ˆå±€ */
        @media (min-width: 1024px) {
            #game-container {
                grid-template-columns: 2fr 1fr; /* 2/3 vs 1/3 æ¯”ä¾‹ */
            }
        }

        /* å·¦å´å®¹å™¨ç¢ºä¿å…§éƒ¨å ´æ™¯å¡«æ»¿é«˜åº¦ */
        #source-display {
            display: flex;
            flex-direction: column;
            /* è®“å·¦å´é«˜åº¦èˆ‡å³å´å…§å®¹é«˜åº¦ä¸€è‡´ */
            flex-grow: 1;
        }
        
        /* å·¦å´å ´æ™¯å®¹å™¨ä½”æ“šå‰©é¤˜ç©ºé–“ */
        #busy-scene {
            flex-grow: 1; 
            position: relative;
        }


        /* æ ¸å¿ƒå¹²æ“¾ç‰©å’Œç›®æ¨™ç·šç´¢çš„é€šç”¨æ¨£å¼ */
        .distraction-item { 
            position: absolute;
            font-size: 3rem; 
            opacity: 0.85; /* è¼•å¾®æé«˜é€æ˜åº¦ï¼Œæ¨¡æ“¬åº•åœ–èå…¥ */
            pointer-events: none;
            line-height: 1; 
            text-shadow: none; 
        }
        
        /* æ ¸å¿ƒç·šç´¢å®¹å™¨ï¼šæ°´æœèˆ‡åœ“åœˆç›¸é„°æ’åˆ— (ç”¨æ–¼å®šä½ç¾¤çµ„) */
        .fruit-clue {
            position: absolute; 
            display: block; 
            width: 50px; 
            height: 50px;
            line-height: 1; 
            pointer-events: none; 
        }

        /* æ ¸å¿ƒç·šç´¢ï¼šæ°´æœ Emoji (ä½æ–¼ç¾¤çµ„å…§) */
        .fruit-clue .fruit-emoji {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1; 
            font-size: 3rem; 
            text-shadow: none;
            z-index: 50; 
        }

        /* æ°´æœæ—é‚Šçš„æ ¸å¿ƒç·šç´¢åœ“åœˆ (ç·šç´¢) - å›ºå®šåç§»ï¼Œç¢ºä¿æ­¸å±¬æ¸…æ™° */
        .fruit-clue .color-bubble {
            position: absolute; 
            top: 5%;      /* å›ºå®šåœ¨ç¾¤çµ„å³ä¸Šè§’ */
            right: -10px; 
            width: 25px; 
            height: 25px; 
            border-radius: 50%;
            border: 3px solid #000; 
            box-shadow: 0 0 3px rgba(255, 255, 255, 0.8); 
            z-index: 51; 
        }

        /* å–®è‰²æ»‘å‹•é¸å–®æ¨£å¼ */
        .single-color-picker {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 8px;
            background-color: #f3f4f6;
            border-radius: 12px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            width: 140px; 
        }
        
        .arrow-button {
            background-color: #e5e7eb;
            color: #374151;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 1.25rem;
            font-weight: bold;
            line-height: 1;
            transition: background-color 0.15s, transform 0.15s;
        }
        .arrow-button:hover:not(:disabled) {
            background-color: #d1d5db;
            transform: scale(1.05);
        }
        
        /* TTS è¼‰å…¥å‹•ç•« (ä¸å†ä½¿ç”¨) */
        .tts-loading:after {
            content: '.';
            animation: loading 1s steps(5, end) infinite;
        }
        @keyframes loading {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: '....'; }
        }
        
        /* Modal æ¨£å¼ */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.open {
            visibility: visible;
            opacity: 1;
        }
        
        /* å³å´å¯é»æ“Šåœ–æ¡ˆæ¨£å¼ */
        .target-label {
            cursor: pointer;
            transition: transform 0.1s;
        }
        .target-label:hover {
            transform: scale(1.05);
        }

        /* èª¿æ•´ä¸»å®¹å™¨ä»¥ä½”ç”¨æ›´å¤šå‚ç›´ç©ºé–“ï¼Œæ¸›å°‘æ»¾å‹• */
        #app {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
    </style>
</head>
<body class="min-h-screen"> <!-- ç¢ºä¿ body ä½”æ»¿é«˜åº¦ -->

    <div id="app" class="w-full max-w-6xl bg-white p-4 sm:p-8 rounded-2xl shadow-2xl border border-gray-100 flex-grow">

        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-4 text-center">
            ğŸ‘¨â€ğŸ³ å»šå¸«å·´ç‰¹çš„å®´æœƒæŒ‘æˆ°ï¼šå°ˆæ³¨åŠ›ä»»å‹™ ğŸ§ 
        </h1>
        
        <!-- ç§»é™¤åŸé ‚éƒ¨æ•…äº‹å€ï¼Œæ”¹ç‚ºåœ¨ Modal ä¸­é¡¯ç¤º -->
        <div class="text-xl font-bold text-center text-blue-600 mb-6">
            <span id="level-display">é—œå¡è¼‰å…¥ä¸­...</span>
        </div>
        
        
        <!-- èª¿æ•´ï¼šåœ¨ lg è¢å¹•ä¸Šï¼Œå·¦å´ä½” 2/3 å¯¬åº¦ï¼Œå³å´ä½” 1/3 å¯¬åº¦ -->
        <div id="game-container" class="gap-6 sm:gap-10">
            
            <!-- å·¦å´ï¼šè¤‡é›œåˆåˆ†æ•£æ³¨æ„åŠ›çš„å ´æ™¯ï¼ˆè³‡è¨Šä¾†æºï¼‰ -->
            <div id="source-display" class="p-0 bg-yellow-50 rounded-xl border-4 border-yellow-300 shadow-inner overflow-hidden">
                <h2 id="source-title" class="text-xl sm:text-2xl font-bold text-yellow-800 p-4 border-b border-yellow-300 bg-yellow-100">
                    ç›®æ¨™ï¼šæ‰¾å‡ºå³å´ç›®æ¨™ç‰©æ—é‚Šçš„é¡è‰²æ¨™ç±¤
                </h2>
                
                <div id="busy-scene" class="busy-scene">
                    <div id="mixed-items-container" class="absolute top-0 left-0 w-full h-full">
                    </div>
                </div>
                
            </div>

            <!-- å³å´ï¼šæŒ‘æˆ°å€ (ä½œç­”å€) - å¯¬åº¦ç¸®å° -->
            <div id="answer-panel" class="p-4 sm:p-6 bg-blue-50 rounded-xl border-4 border-blue-300 shadow-inner flex flex-col flex-grow">
                <h2 class="text-xl sm:text-2xl font-bold text-blue-800 mb-4 border-b pb-2">
                    å³å´ï¼šæŒ‘æˆ°åºåˆ—ï¼ˆè«‹é»æ“Šç®­é ­é¸å‡ºæ­£ç¢ºçš„é¡è‰²ï¼‰
                </h2>
                <div id="challenge-input" class="space-y-3"> <!-- ä¿®æ­£: space-y-4 æ”¹ç‚º space-y-3ï¼Œæ›´ç·Šæ¹Š -->
                    <!-- æŒ‘æˆ°ç›®æ¨™å’Œé¡è‰²é¸å–®å°‡ç”± JS æ¸²æŸ“è‡³æ­¤ -->
                </div>

                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button id="check-button" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold text-lg hover:bg-green-700 transition duration-150 shadow-md shadow-green-300 active:shadow-none active:translate-y-0.5 disabled:bg-gray-400">
                        âœ… æª¢æŸ¥ç­”æ¡ˆ
                    </button>
                    <button id="reset-button" class="sm:w-auto bg-gray-300 text-gray-800 py-3 px-6 rounded-xl font-bold text-lg hover:bg-gray-400 transition duration-150 shadow-md active:shadow-none active:translate-y-0.5">
                        ğŸ”„ é‡ç©æœ¬é—œ
                    </button>
                </div>
                
                <div id="message-box" class="mt-6 p-4 text-center text-xl font-semibold rounded-lg hidden border-2">
                    <!-- éŠæˆ²è¨Šæ¯èˆ‡çµæœé¡¯ç¤ºå€ (åƒ…ç”¨æ–¼éŒ¯èª¤æç¤º) -->
                </div>
            </div>

        </div>
        
    </div>
    
    <!-- æ•…äº‹èªªæ˜ Modal (æ–°æµç¨‹ï¼šé–‹å ´å°±å½ˆå‡º) -->
    <div id="story-modal" class="modal-overlay open">
        <div id="story-modal-content" class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-md w-full transform scale-100 transition-transform duration-300">
            <h3 id="modal-story-title" class="text-3xl font-extrabold text-purple-700 mb-4">ä»»å‹™èªªæ˜</h3>
            <p id="modal-story-text" class="text-xl text-gray-700 mb-6"></p>
            <button id="story-modal-tts-button" class="bg-purple-500 text-white py-2 px-4 rounded-full font-bold text-sm hover:bg-purple-600 transition duration-150 mb-4 disabled:bg-gray-400">
                ğŸ”Š å ±è®€æ•…äº‹
            </button>
            <button id="start-challenge-button" class="bg-blue-600 text-white py-3 px-8 rounded-xl font-bold text-lg hover:bg-blue-700 transition duration-150 shadow-lg shadow-blue-300">
                ğŸš€ é–‹å§‹æŒ‘æˆ°
            </button>
        </div>
    </div>

    <!-- æˆåŠŸç ´é—œ Modal ç•«é¢ -->
    <div id="success-modal" class="modal-overlay">
        <div id="modal-content" class="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full transform scale-90 transition-transform duration-300">
            <div class="text-7xl mb-4 animate-bounce">ğŸ†</div>
            <h3 id="modal-title" class="text-3xl font-extrabold text-green-700 mb-2"></h3>
            <p id="modal-message" class="text-xl text-gray-700 mb-6"></p>
             <button id="modal-tts-button" class="bg-purple-500 text-white py-2 px-4 rounded-full font-bold text-sm hover:bg-purple-600 transition duration-150 mb-4 disabled:bg-gray-400">
                ğŸ”Š å ±è®€æ•…äº‹
            </button>
            <button id="modal-action-button" class="bg-blue-600 text-white py-3 px-8 rounded-xl font-bold text-lg hover:bg-blue-700 transition duration-150 shadow-lg shadow-blue-300">
                <!-- æŒ‰éˆ•æ–‡å­—å°‡ç”± JS è¨­å®š -->
            </button>
        </div>
    </div>

    <!-- æˆåŠŸéŸ³æ•ˆå…ƒç´  (ä½¿ç”¨ Tone.js æ¨¡æ“¬) -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.71/build/Tone.min.js"></script>

    <script>
        // ----------------------------------------------------
        // 1. éŠæˆ²è³‡æ–™èˆ‡è¨­å®š
        // ----------------------------------------------------

        // åŸºç¤ç›®æ¨™æ•¸æ“š (åç¨±, Emoji/åœ–æ¡ˆ)
        const OBJECT_DATA = [
            { type: 'fruit', name: 'è˜‹æœ', emoji: 'ğŸ' }, 
            { type: 'fruit', name: 'é¦™è•‰', emoji: 'ğŸŒ' }, 
            { type: 'fruit', name: 'è‘¡è„', emoji: 'ğŸ‡' }, 
            { type: 'fruit', name: 'å¥‡ç•°æœ', emoji: 'ğŸ¥' }, 
            { type: 'fruit', name: 'æ©˜å­', emoji: 'ğŸŠ' }, 
            { type: 'fruit', name: 'è—è“', emoji: 'ğŸ«' }, 
            { type: 'fruit', name: 'è‰è“', emoji: 'ğŸ“' }, 
            // æ•¸å­¸æŒ‘æˆ° (Level 2 - éœ€è¦è‡³å°‘ 7 å€‹ç¨ç‰¹ç›®æ¨™ç‰©)
            { type: 'math', name: 'é¤…ä¹¾', emoji: 'ğŸª' }, 
            { type: 'math', name: 'ç³–æœ', emoji: 'ğŸ¬' }, 
            { type: 'math', name: 'ç”œç”œåœˆ', emoji: 'ğŸ©' },
            { type: 'math', name: 'å†°æ·‡æ·‹', emoji: 'ğŸ¦' },
            { type: 'math', name: 'æ£’æ£’ç³–', emoji: 'ğŸ­' },
            { type: 'math', name: 'çˆ†ç±³èŠ±', emoji: 'ğŸ¿' },
            { type: 'math', name: 'é¬†é¤…', emoji: 'ğŸ§‡' }, 
            // çƒ¹é£ªå·¥å…· (Level 3)
            { type: 'tool', name: 'åˆ€å…·', emoji: 'ğŸ”ª' }, 
            { type: 'tool', name: 'å‹ºå­', emoji: 'ğŸ¥„' }, 
            { type: 'tool', name: 'è¨ˆæ™‚å™¨', emoji: 'â±ï¸' }, 
            { type: 'tool', name: 'çˆç¶', emoji: 'ğŸ”¥' }, 
            { type: 'tool', name: 'éºµåŒ…æ©Ÿ', emoji: 'ğŸ' }, 
            { type: 'tool', name: 'ç£¨å…·', emoji: 'âš™ï¸' }, 
            { type: 'tool', name: 'æ°´å£º', emoji: 'ğŸ«–' }, 
            // é£Ÿç‰© (å·²åŠ å·¥) (Level 4, 5)
            { type: 'food', name: 'è›‹ç³•', emoji: 'ğŸ°' }, 
            { type: 'food', name: 'æŠ«è–©', emoji: 'ğŸ•' }, 
            { type: 'food', name: 'æ¼¢å ¡', emoji: 'ğŸ”' }, 
            { type: 'food', name: 'æ²™æ‹‰', emoji: 'ğŸ¥—' }, 
            { type: 'food', name: 'å£½å¸', emoji: 'ğŸ£' }, 
            { type: 'food', name: 'ç¾©å¤§åˆ©éºµ', emoji: 'ğŸ' }, 
            { type: 'food', name: 'ç‡‰èœ', emoji: 'ğŸ²' }, 
        ];

        // é¡è‰²é¸é … (Hex å€¼)
        const COLOR_OPTIONS = [
            { hex: '#ef4444', name: 'ç´…è‰²' },    
            { hex: '#facc15', name: 'é»ƒè‰²' },    
            { hex: '#a855f7', name: 'ç´«è‰²' },    
            { hex: '#4ade80', name: 'ç¶ è‰²' },    
            { hex: '#f97316', name: 'æ©˜è‰²' },    
            { hex: '#3b82f6', name: 'è—è‰²' },    
            { hex: '#ec4899', name: 'ç²‰è‰²' },    
        ];
        
        // é¡å¤–å¹²æ“¾ç‰©
        const DISTRACTOR_POOL = ['ğŸ›’', 'ğŸ’¸', 'ğŸ“¦', 'ğŸªœ', 'ğŸ§º', 'ğŸ–Šï¸', 'ğŸ—’ï¸', 'ğŸ””', 'â˜‚ï¸', 'ğŸ§»', 'ğŸª‘', 'ğŸ¥¤', 'ğŸ¥©', 'ğŸ§€', 'ğŸŸ', 'ğŸŒ¶ï¸', 'ğŸ§…', 'ğŸ¥•', 'ğŸ¥¦', 'ğŸ¥¬', 'ğŸ†', 'ğŸ¥’', 'ğŸ”¨', 'âœ‚ï¸', 'ğŸ·ï¸', 'ğŸ–ï¸', 'ğŸ”‹', 'ğŸ”‘', 'ğŸ•°ï¸', 'ğŸ”¦'];

        const BG_COLOR_PALETTES = [
            { main: '#5d4037', secondary: '#795548' }, // æ¡è²·å¸‚å ´/æœ¨æ¿ (Level 1)
            { main: '#2c3e50', secondary: '#34495e' }, // çµå¸³å°/å†·è‰²èª¿ (Level 2)
            { main: '#38761d', secondary: '#6aa84f' }, // æº–å‚™å°/ç¶ è‰²ç §æ¿ (Level 3)
            { main: '#a64d79', secondary: '#d9a74a' }, // çƒ¹é£ªå€/ç«çˆç†±è‰²èª¿ (Level 4)
            { main: '#4b0082', secondary: '#9400d3' }, // ä¸Šèœ/ç´«è‰²å„ªé›… (Level 5)
        ];
        
        // é—œå¡æ•…äº‹ç·š
        const LEVEL_CONFIGS = [
            null, 
            { level: 1, distractorCount: 20, totalItems: 27, title: "æ¡è³¼é£Ÿæï¼šæ°´æœæ”¤ä¸Šçš„ç·Šæ€¥ä»»å‹™",
              story: "ğŸ‘¨â€ğŸ³ å»šå¸«å·´ç‰¹æº–å‚™ä¸€å ´ç››å¤§çš„å®´æœƒï¼é¦–å…ˆï¼Œä»–ä¾†åˆ°æ··äº‚çš„æ°´æœæ”¤ã€‚ä¸ƒç¨®é‡è¦çš„æ°´æœéƒ½è¢«æ¨™ä¸Šäº†ç§˜å¯†é¡è‰²æ¨™ç±¤ã€‚è«‹ä½ å¹«åŠ©å·´ç‰¹ï¼Œåœ¨é›œäº‚çš„æ”¤ä½ä¸Šæ‰¾åˆ°é€™äº›æ°´æœæ—é‚Šçš„åœ“åœˆé¡è‰²ï¼Œä¸¦åœ¨å³å´æº–ç¢ºé…å°ã€‚", objectType: 'fruit' },
            { level: 2, distractorCount: 30, totalItems: 37, title: "æ¸…é»è²¨ç‰©ï¼šçµå¸³å°ä¸Šçš„é»å¿ƒé…å°",
              story: "ğŸ’¸ é£Ÿæéƒ½è²·å¥½äº†ï¼Œä½†ç¾åœ¨è¦åœ¨çµå¸³å‰æ¸…é»æ•¸é‡ã€‚ä½ éœ€è¦æ‰¾åˆ°ä¸ƒå€‹å¸¶æœ‰æ¨™ç±¤çš„**é»å¿ƒ**ï¼Œä¸¦å°‡å®ƒå€‘æ—é‚Šçš„**åœ“åœˆé¡è‰²**èˆ‡å³å´çš„åœ–æ¡ˆæº–ç¢ºé…å°ã€‚", objectType: 'math' },
            { level: 3, distractorCount: 35, totalItems: 42, title: "å®´æœƒæº–å‚™ï¼šå»šå…·è¾¨è­˜èˆ‡å®šä½",
              story: "ğŸ”ª å›åˆ°å»šæˆ¿ï¼Œç¾åœ¨è¦æº–å‚™é£Ÿæå’Œå·¥å…·ã€‚å»šæˆ¿è£¡å †æ»¿äº†å„ç¨®é‹ç¢—ç“¢ç›†ï¼Œä¸ƒç¨®é—œéµçš„**å»šæˆ¿å·¥å…·**ä¹Ÿè²¼ä¸Šäº†é¡è‰²æ¨™ç±¤ã€‚ä½ éœ€è¦å¾é›œäº‚çš„æº–å‚™å°ä¸Šæ‰¾å‡ºé€™äº›å·¥å…·çš„é¡è‰²æ¨™ç±¤ã€‚", objectType: 'tool' },
            { level: 4, distractorCount: 45, totalItems: 52, title: "ç†±ç«çƒ¹é£ªï¼šä¸»é£Ÿçƒ˜ç„™è€ƒé©—",
              story: "ğŸ”¥ é–‹å§‹çƒ¹é£ªï¼éºµåŒ…ã€è›‹ç³•å’ŒæŠ«è–©æ­£åœ¨çƒ˜çƒ¤ã€‚ä½†å› ç‚ºçˆç«å¤ªæ—ºï¼Œä¸ƒç¨®**æ­£åœ¨è£½ä½œçš„ä¸»é£Ÿ**è¢«ç«ç„°å’Œè’¸æ±½é®æ“‹ã€‚è«‹åœ¨å……æ»¿ç†±æ°£çš„çƒ¹é£ªå€ï¼Œè¾¨è­˜å‡ºé€™ä¸ƒå€‹ä¸»é£Ÿçš„é¡è‰²æ¨™ç±¤ã€‚", objectType: 'food' },
            { level: 5, distractorCount: 50, totalItems: 57, title: "å®Œç¾ä¸Šèœï¼šæœ€çµ‚çš„è¦–è¦ºæ ¡å°",
              story: "âœ¨ å®´æœƒå³å°‡é–‹å§‹ï¼Œå·´ç‰¹è¦å°‡ä¸ƒç¨®ä¸åŒçš„**ç²¾ç¾èœé¤š**ç«¯ä¸Šæ¡Œã€‚è«‹åœ¨è¯éº—ä½†æ“æ“ çš„é¤æ¡Œä½ˆæ™¯ä¸­ï¼Œæ‰¾å‡ºé€™ä¸ƒç¨®èœé¤šæ—é‚Šçš„é¡è‰²æ¨™ç±¤ï¼Œå®Œæˆæœ€å¾Œçš„é…å°ï¼", objectType: 'food' },
        ];
        
        const FINAL_STORY = {
            title: "ğŸ‰ å®´æœƒå¤§æˆåŠŸï¼",
            message: "ã€Œå¤ªæ£’äº†ï¼æ‰€æœ‰ä»»å‹™åœ“æ»¿é”æˆï¼ã€å»šå¸«å·´ç‰¹é«˜èˆˆåœ°å–Šé“ã€‚å› ç‚ºä½ çš„é«˜è¶…å°ˆæ³¨åŠ›ã€ä»”ç´°çš„è§€å¯Ÿå’Œå¿«é€Ÿçš„åæ‡‰ï¼Œæ‰€æœ‰é£Ÿæã€å·¥å…·å’Œèœé¤šéƒ½ç²¾æº–åˆ°ä½ã€‚ç¾åœ¨ï¼Œè³“å®¢å€‘å¯ä»¥ç›¡æƒ…äº«å—é€™å ´ç”±ä½ å’Œå·´ç‰¹å…±åŒåŠªåŠ›å®Œæˆçš„ç››å®´äº†ï¼ä½ æ˜¯æœ€æ£’çš„å¸‚å ´åµæ¢ï¼",
            actionText: "ğŸ† é‡æ–°é–‹å§‹ç¬¬ä¸€é—œ"
        };
        
        // ------------------------------------------------------------------
        // *** ç§»é™¤è‡ªéŒ„éŸ³æª” URL é…ç½®ï¼Œæ”¹ç‚ºé€šç”¨ TTS ***
        // ------------------------------------------------------------------
        
        let challengeSequence = [];
        let currentMapping = []; 
        let userSelections = []; 
        let userColorIndex = []; 
        let currentLevel = 1; 
        
        // ----------------------------------------------------
        // 2. DOM å…ƒç´ å–å¾—
        // ----------------------------------------------------

        const mixedItemsContainerEl = document.getElementById('mixed-items-container');
        const challengeInputEl = document.getElementById('challenge-input');
        const checkButton = document.getElementById('check-button');
        const resetButton = document.getElementById('reset-button');
        const messageBoxEl = document.getElementById('message-box');
        const successModalEl = document.getElementById('success-modal');
        const modalContentEl = document.getElementById('modal-content');
        const modalTitleEl = document.getElementById('modal-title');
        const modalMessageEl = document.getElementById('modal-message');
        const modalActionButton = document.getElementById('modal-action-button');
        const modalTtsButton = document.getElementById('modal-tts-button'); 
        const levelDisplayEl = document.getElementById('level-display');
        const storyModalEl = document.getElementById('story-modal'); // å–å¾—æ•…äº‹ Modal
        const modalStoryTitleEl = document.getElementById('modal-story-title');
        const modalStoryTextEl = document.getElementById('modal-story-text');
        const modalStoryTtsButton = document.getElementById('story-modal-tts-button');
        const startChallengeButton = document.getElementById('start-challenge-button');
        const sourceTitleEl = document.getElementById('source-title');
        const answerPanelEl = document.getElementById('answer-panel'); 
        
        // Audio Player 
        let audioContext;

        
        // ----------------------------------------------------
        // 3. è¼”åŠ©å·¥å…· (TTS/éŸ³æ•ˆ/é€šç”¨)
        // ----------------------------------------------------
        
        // Regex to match most common Emojis/symbols
        const EMOJI_REGEX = /(\p{Extended_Pictographic}|\p{Emoji_Component}|\p{Emoji_Modifier}|\p{Emoji_Modifier_Base})/gu;

        /** èªè©æœ—è®€ (ä½¿ç”¨ç€è¦½å™¨å…§å»º TTSï¼Œé€Ÿåº¦å¿«ï¼Œé›¶å»¶é²) */
        function readWord(word) {
            if ('speechSynthesis' in window) {
                // 1. éæ¿¾æ‰ Emoji/åœ–ç¤º
                let cleanWord = word.replace(EMOJI_REGEX, '').trim(); 
                
                // 2. ç§»é™¤ Level 3 æ•…äº‹ä¸­çš„åœ–ç¤º (é›–ç„¶ Level 3 å·²ç¶“æ˜¯ç´”æ–‡å­—ï¼Œä½†ç‚ºäº†å®‰å…¨å†æ¬¡éæ¿¾)
                if (cleanWord.startsWith('ğŸ”ª')) cleanWord = cleanWord.substring(1).trim();
                
                if (cleanWord === "") return; // å¦‚æœæ¸…ç©ºå¾Œæ˜¯ç©ºå­—ä¸²å‰‡ä¸å ±è®€

                // åœ¨é–‹å§‹æ–°çš„èªéŸ³å‰ï¼Œåœæ­¢ä»»ä½•æ­£åœ¨æ’­æ”¾çš„èªéŸ³
                window.speechSynthesis.cancel(); 
                
                const utterance = new SpeechSynthesisUtterance(cleanWord);
                utterance.lang = 'zh-TW'; 
                // èª¿æ•´èªé€Ÿå’ŒéŸ³èª¿ï¼Œä½¿å…¶è½èµ·ä¾†æ¸…æ™°å¿«é€Ÿ
                utterance.rate = 1.5; 
                utterance.pitch = 1.0; 
                window.speechSynthesis.speak(utterance);
            } else {
                console.warn("ç€è¦½å™¨ä¸æ”¯æ´ Web Speech APIã€‚");
            }
        }

        /** æ’­æ”¾ç ´é—œéŸ³æ•ˆ (é€šç”¨æˆåŠŸéŸ³) */
        function playSuccessSound() {
            try {
                // ç”±æ–¼ Tone.js å·²ç¶“åœ¨ startChallenge() ä¸­å•Ÿå‹•ï¼Œé€™è£¡åªéœ€èª¿ç”¨
                const synth = new Tone.MembraneSynth({
                    pitchDecay: 0.05, octaves: 1, oscillator: { type: 'sine' },
                    envelope: { attack: 0.001, decay: 0.2, sustain: 0.01, release: 0.2, level: 0.5 }
                }).toDestination();
                
                synth.triggerAttackRelease("C5", "8n");
                synth.triggerAttackRelease("G5", "8n", "+0.05");
                synth.triggerAttackRelease("C6", "8n", "+0.1");

            } catch (error) {
                console.error("ç„¡æ³•æ’­æ”¾éŸ³æ•ˆï¼Œå¯èƒ½æ˜¯ç€è¦½å™¨é™åˆ¶æˆ– Tone.js éŒ¯èª¤:", error);
            }
        }
        
        /** æ’­æ”¾æœ€çµ‚å‹åˆ©éŸ³æ•ˆ (æ‹æ‰‹/æ­¡å‘¼) */
        function playFinalSuccessSound() {
            try {
                // ç”±æ–¼ Tone.js å·²ç¶“åœ¨ startChallenge() ä¸­å•Ÿå‹•ï¼Œé€™è£¡åªéœ€èª¿ç”¨
                // æ¨¡æ“¬æ‹æ‰‹/é¼“æŒçš„è²éŸ³
                const clap = new Tone.NoiseSynth({
                    noise: { type: 'pink' },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.05 }
                }).toDestination();

                // æ­¡å‘¼çš„éŸ³é«˜
                const cheerSynth = new Tone.MembraneSynth({
                    envelope: { attack: 0.01, decay: 0.5, sustain: 0.01, release: 0.5 }
                }).toDestination();

                // å¿«é€Ÿé¼“æŒåºåˆ—
                clap.triggerAttackRelease("8n", 0);
                clap.triggerAttackRelease("8n", "+0.1");
                clap.triggerAttackRelease("8n", "+0.2");

                // æ­¡å‘¼è²
                cheerSynth.triggerAttackRelease("G4", "4n", "+0.3");
                cheerSynth.triggerAttackRelease("C5", "4n", "+0.6");

            } catch (error) {
                console.error("ç„¡æ³•æ’­æ”¾æœ€çµ‚éŸ³æ•ˆ:", error);
                playSuccessSound(); // fallback
            }
        }


        /** éš¨æ©Ÿæ‰“äº‚é™£åˆ— */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        // ----------------------------------------------------
        // 4. éŠæˆ²é‚è¼¯èˆ‡å‡½å¼
        // ----------------------------------------------------

        /** ç”¢ç”Ÿæœ¬æ¬¡æŒ‘æˆ°çš„éš¨æ©Ÿç›®æ¨™åºåˆ—å’Œé¡è‰²é…å° */
        function generateChallengeAndMapping() {
            const config = LEVEL_CONFIGS[currentLevel];
            
            // æ ¹æ“šé—œå¡é¡å‹ç¯©é¸ç›®æ¨™ç‰©
            const objectPool = OBJECT_DATA.filter(obj => obj.type === config.objectType);
            
            // ç¢ºä¿æœ‰ä¸ƒç¨®ç›®æ¨™ç‰©ä¾†é…å°ä¸ƒç¨®é¡è‰²
            let challengeTargets = [...objectPool];
            while (challengeTargets.length < 7) {
                 // å¦‚æœé¡å‹æ•¸é‡ä¸è¶³7ï¼Œå‰‡å¾è©²é¡å‹ä¸­éš¨æ©ŸæŠ½å–é‡è¤‡ä½¿ç”¨
                challengeTargets.push(objectPool[Math.floor(Math.random() * objectPool.length)]);
            }
            challengeTargets = challengeTargets.slice(0, 7); // å–å‰ä¸ƒå€‹

            // éš¨æ©Ÿæ‰“äº‚é¡è‰²
            const shuffledColors = [...COLOR_OPTIONS];
            shuffleArray(shuffledColors);

            // å»ºç«‹ç›®æ¨™ç‰© -> é¡è‰² çš„éš¨æ©Ÿé…å°
            currentMapping = challengeTargets.map((item, index) => ({
                emoji: item.emoji,
                name: item.name,
                correctHex: shuffledColors[index].hex,
                mathLabel: null 
            }));

            // å»ºç«‹æŒ‘æˆ°åºåˆ— (å³å´çš„é¡Œç›®)
            challengeSequence = [...currentMapping];
            shuffleArray(challengeSequence); 
        }
        
        /** æª¢æŸ¥æ–°ä½ç½®æ˜¯å¦èˆ‡ç¾æœ‰çš„æ ¸å¿ƒç·šç´¢é‡ç–Š */
        function isOverlapping(newPos, existingPositions, sceneWidth, sceneHeight) {
            // æ ¸å¿ƒç·šç´¢ä¹‹é–“ä¿æŒæœ€å° 35% çš„è·é›¢ (ç¢ºä¿è¦–è¦ºåˆ†é›¢)
            const minDistanceX = sceneWidth * 0.35; 
            const minDistanceY = sceneHeight * 0.35;

            // è½‰æ›ç™¾åˆ†æ¯”ä½ç½®åˆ°åƒç´ ï¼ˆè¿‘ä¼¼å€¼ï¼‰
            const newX = newPos.left * sceneWidth / 100;
            const newY = newPos.top * sceneHeight / 100;
            
            for (const existing of existingPositions) {
                const existingX = existing.left * sceneWidth / 100;
                const existingY = existing.top * sceneHeight / 100;

                const dx = Math.abs(newX - existingX);
                const dy = Math.abs(newY - existingY);

                if (dx < minDistanceX && dy < minDistanceY) {
                    return true;
                }
            }
            return false;
        }

        /** æ¸²æŸ“å·¦å´çš„è¤‡é›œå ´æ™¯ï¼ˆè³‡è¨Šä¾†æºï¼‰ */
        function renderSourceDisplay() {
            const config = LEVEL_CONFIGS[currentLevel];
            const busySceneEl = document.getElementById('busy-scene');
            const mixedItemsContainerEl = document.getElementById('mixed-items-container');
            
            // ç²å–å ´æ™¯å°ºå¯¸ï¼Œç”¨æ–¼é˜²é‡ç–Šè¨ˆç®—
            const sceneWidth = busySceneEl.clientWidth || 500;
            const sceneHeight = busySceneEl.clientHeight || 500;

            // 1. éš¨æ©Ÿè¤‡é›œèƒŒæ™¯
            const randomPalette = BG_COLOR_PALETTES[currentLevel - 1] || BG_COLOR_PALETTES[0]; 
             busySceneEl.style.backgroundImage = `repeating-linear-gradient(
                ${Math.floor(Math.random() * 90)}deg,
                ${randomPalette.secondary} 0,
                ${randomPalette.secondary} 2px,
                ${randomPalette.main} 2px,
                ${randomPalette.main} 25px
            )`;
            busySceneEl.style.backgroundColor = randomPalette.main;
            
            mixedItemsContainerEl.innerHTML = '';
            
            const allItems = [];
            
            // ç”¨ä¾†è¨˜éŒ„å·²ç¢ºå®šçš„æ ¸å¿ƒç·šç´¢ä½ç½®
            const confirmedCluePositions = [];

            // 2. æ ¸å¿ƒç·šç´¢ (å¸¶åœ“åœˆçš„ç›®æ¨™ç‰©) - ç¸½å…± 7 çµ„
            currentMapping.forEach((item, index) => {
                let pos;
                let attempts = 0;
                let validPosition = false;

                // å˜—è©¦æ‰¾å°‹ä¸é‡ç–Šçš„ä½ç½® (æœ€å¤šå˜—è©¦ 50 æ¬¡)
                while (!validPosition && attempts < 50) {
                    pos = { 
                        top: Math.random() * 80 + 10, // é¿å…é‚Šç·£
                        left: Math.random() * 80 + 10 
                    };
                    pos.topPercent = `${pos.top}%`;
                    pos.leftPercent = `${pos.left}%`;

                    if (!isOverlapping(pos, confirmedCluePositions, sceneWidth, sceneHeight)) {
                        validPosition = true;
                    }
                    attempts++;
                }

                if (validPosition) {
                    confirmedCluePositions.push(pos);
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°ä¸é‡ç–Šä½ç½®ï¼Œå‰‡å¼·åˆ¶ä½¿ç”¨ä¸€å€‹éš¨æ©Ÿä½ç½® (ä¸å®Œç¾ä½†å¿…é ˆé¡¯ç¤º)
                    pos = { topPercent: `${Math.random() * 90 + 5}%`, leftPercent: `${Math.random() * 90 + 5}%` };
                }
                
                const rotation = Math.floor(Math.random() * 180) - 90; 
                const zIndex = Math.floor(Math.random() * 10) + 1; 
                
                const clueHtml = `
                    <div class="fruit-clue distraction-item" style="
                        top: ${pos.topPercent}; left: ${pos.leftPercent}; 
                        transform: translate(-50%, -50%) rotate(${rotation}deg);
                        font-size: 3rem; 
                        z-index: ${zIndex + 10}; 
                    ">
                        <span class="fruit-emoji"> 
                            ${item.emoji}
                        </span>
                        <div class="color-bubble" style="background-color: ${item.correctHex};"></div>
                    </div>
                `;
                allItems.push(clueHtml);
            });

            // 3. æ¸²æŸ“å¹²æ“¾ç‰©
            const distractorCount = config.totalItems - currentMapping.length;
            for (let i = 0; i < distractorCount; i++) {
                const useChallengeTargetAsDistractor = Math.random() < 0.2; 
                
                let emoji;
                let hasExtraLabel = false; 

                if (useChallengeTargetAsDistractor) {
                    // ä½¿ç”¨ç•¶å‰æŒ‘æˆ°ç›®æ¨™çš„ Emoji ä½œç‚ºå¹²æ“¾ç‰©
                    const targetPool = OBJECT_DATA.filter(obj => obj.type === config.objectType);
                    const randomTarget = targetPool[Math.floor(Math.random() * targetPool.length)];
                    emoji = randomTarget.emoji;
                } else {
                    emoji = DISTRACTOR_POOL[Math.floor(Math.random() * DISTRACTOR_POOL.length)];
                }
                
                // ç§»é™¤ Level 2 çš„æ•¸å­—å¹²æ“¾
                if (currentLevel === 2 && Math.random() < 0.2) {
                    hasExtraLabel = false; // ç¢ºä¿ä¸ç”¢ç”Ÿå¸¶æ•¸å­—çš„å¹²æ“¾ç‰©
                    // ä¿ç•™é»å¿ƒé¡çš„ emoji ä½œç‚ºå¹²æ“¾ï¼Œä½†ä¸å¸¶æ•¸å­—æ¨™ç±¤
                    const targetPool = OBJECT_DATA.filter(obj => obj.type === 'math');
                    const randomTarget = targetPool[Math.floor(Math.random() * targetPool.length)];
                    emoji = randomTarget.emoji;
                }


                const pos = { 
                    top: `${Math.random() * 90 + 5}%`, 
                    left: `${Math.random() * 90 + 5}%` 
                };

                const rotation = Math.floor(Math.random() * 180) - 90; 
                const size = Math.floor(Math.random() * 3) + 2; 
                const zIndex = Math.floor(Math.random() * 10) + 1; 
                
                // ç¢ºä¿å¹²æ“¾ç‰©èˆ‡æ ¸å¿ƒç·šç´¢ä½¿ç”¨ç›¸ä¼¼çš„ z-index
                const distractorZIndex = zIndex; 

                const distractorHtml = `
                    <span class="distraction-item" style="
                        top: ${pos.top}; left: ${pos.left}; 
                        transform: translate(-50%, -50%) rotate(${rotation}deg); 
                        font-size: ${size}rem;
                        z-index: ${distractorZIndex}; 
                    ">
                        ${emoji}
                    </span>
                `;
                allItems.push(distractorHtml);
            }
            
            shuffleArray(allItems); 
            mixedItemsContainerEl.innerHTML = allItems.join('');

            levelDisplayEl.textContent = config.title;
            sourceTitleEl.textContent = `å ´æ™¯ï¼š${config.title}`;
        }

        /** æ¸²æŸ“å³å´çš„æŒ‘æˆ°å€èˆ‡å–®è‰²æ»‘å‹•é¸å–® */
        function renderChallengeInput() {
            challengeInputEl.innerHTML = '';
            userSelections = challengeSequence.map(() => COLOR_OPTIONS[0].hex); // é è¨­ç‚ºç¬¬ä¸€å€‹é¡è‰²
            userColorIndex = challengeSequence.map(() => 0); // é è¨­ç´¢å¼•ç‚º 0

            challengeSequence.forEach((target, index) => {
                const row = document.createElement('div');
                row.id = `input-row-${index}`;
                // ä¿®æ­£ï¼š space-y-2 sm:space-y-0 sm:space-x-4 p-3  -> space-y-1 sm:space-y-0 sm:space-x-2 p-2 
                row.className = 'flex flex-col sm:flex-row items-center justify-between space-y-1 sm:space-y-0 sm:space-x-2 p-2 bg-white transition-colors duration-300 rounded-xl shadow-lg border border-gray-200';
                
                const targetLabel = document.createElement('div');
                targetLabel.className = 'target-label flex items-center space-x-3 w-full sm:w-auto';
                
                // å³å´åªé¡¯ç¤ºç›®æ¨™ç‰© Emojiï¼Œä¸é¡¯ç¤ºæ–‡å­—åç¨±
                targetLabel.innerHTML = `
                    <span class="text-3xl">${target.emoji}</span> <!-- ä¿®æ­£ï¼šç§»é™¤ sm:text-4xlï¼Œçµ±ä¸€ç¸®å° -->
                `;
                
                // æ–°å¢ï¼šç›®æ¨™ç‰©é»æ“ŠèªéŸ³å ±è®€ (ä½¿ç”¨å…§å»º TTS)
                targetLabel.addEventListener('click', () => {
                    readWord(target.name);
                });


                const pickerWrapper = document.createElement('div');
                pickerWrapper.className = 'single-color-picker';

                // å·¦ç®­é ­
                const leftArrow = document.createElement('button');
                leftArrow.className = 'arrow-button';
                leftArrow.textContent = 'â—€';
                leftArrow.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateColor(index, -1);
                });

                // é¡è‰²åœ“åœˆ
                const colorCircle = document.createElement('button');
                colorCircle.id = `picker-circle-${index}`;
                colorCircle.className = 'color-circle selected';
                colorCircle.style.backgroundColor = COLOR_OPTIONS[0].hex;
                
                // å³ç®­é ­
                const rightArrow = document.createElement('button');
                rightArrow.className = 'arrow-button';
                rightArrow.textContent = 'â–¶';
                rightArrow.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateColor(index, 1);
                });
                
                // è§¸æ§æ»‘å‹•äº‹ä»¶è™•ç† (Swiping for mobile)
                let startX;
                colorCircle.addEventListener('touchstart', (e) => {
                    startX = e.touches[0].clientX;
                }, {passive: true}); 

                colorCircle.addEventListener('touchend', (e) => {
                    const endX = e.changedTouches[0].clientX;
                    const diff = endX - startX;
                    // æé«˜æ»‘å‹•é–¾å€¼åˆ° 40pxï¼Œè®“é»æ“Šå’Œæ»‘å‹•èƒ½å€åˆ†
                    if (diff > 40) {
                        navigateColor(index, -1); // Swipe right (diff > 0) -> move to previous color (index -1)
                    } else if (diff < -40) {
                        navigateColor(index, 1); // Swipe left (diff < 0) -> move to next color (index +1)
                    }
                });


                pickerWrapper.appendChild(leftArrow);
                pickerWrapper.appendChild(colorCircle);
                pickerWrapper.appendChild(rightArrow);

                row.appendChild(targetLabel);
                row.appendChild(pickerWrapper);
                challengeInputEl.appendChild(row);
            });
        }

        /** å°èˆªé¡è‰²é¸æ“‡ (å·¦å³åˆ‡æ›) */
        function navigateColor(index, direction) {
            let currentIndex = userColorIndex[index];
            currentIndex = (currentIndex + direction) % COLOR_OPTIONS.length;
            if (currentIndex < 0) {
                currentIndex = COLOR_OPTIONS.length - 1;
            }

            userColorIndex[index] = currentIndex;
            const selectedHex = COLOR_OPTIONS[currentIndex].hex;
            userSelections[index] = selectedHex;
            
            const circle = document.getElementById(`picker-circle-${index}`);
            circle.style.backgroundColor = selectedHex;
            circle.className = 'color-circle selected'; 
            messageBoxEl.classList.add('hidden'); 
        }


        /** é¡¯ç¤ºç ´é—œ Modal */
        function showSuccessModal() {
            const isFinalLevel = currentLevel === (LEVEL_CONFIGS.length - 1);
            
            // æ¸…é™¤å³å´é¢æ¿çš„éŒ¯èª¤èƒŒæ™¯è‰²
            answerPanelEl.classList.remove('bg-red-200'); // ç§»é™¤è¼ƒæ·±çš„éŒ¯èª¤è‰²
            answerPanelEl.classList.add('bg-blue-50');
            
            // é‡ç½® modal TTS æŒ‰éˆ•ç‹€æ…‹
            modalTtsButton.disabled = false;
            modalTtsButton.textContent = 'ğŸ”Š å ±è®€æ•…äº‹';


            if (isFinalLevel) {
                modalTitleEl.textContent = FINAL_STORY.title;
                modalMessageEl.textContent = FINAL_STORY.message;
                modalActionButton.textContent = FINAL_STORY.actionText;
                modalActionButton.onclick = () => {
                    currentLevel = 1;
                    closeSuccessModalAndInitGame();
                };
                playFinalSuccessSound(); // æ’­æ”¾æœ€çµ‚å‹åˆ©éŸ³æ•ˆ
                readWord(FINAL_STORY.message); // ä½¿ç”¨å…§å»º TTS å ±è®€æœ€çµ‚æ•…äº‹
                
            } else {
                modalTitleEl.textContent = `âœ… ${LEVEL_CONFIGS[currentLevel].title} - å®Œæˆï¼`;
                modalMessageEl.textContent = `å¤ªæ£’äº†ï¼æ‚¨å·²åœ¨è¤‡é›œçš„å ´æ™¯ä¸­æˆåŠŸæå–æ‰€æœ‰è³‡è¨Šã€‚å·´ç‰¹éœ€è¦ä½ çš„å¹«åŠ©å®Œæˆä¸‹ä¸€é …ä»»å‹™ï¼`;
                modalActionButton.textContent = `ğŸš€ é€²å…¥ä¸‹ä¸€é—œ (Level ${currentLevel + 1})`;
                modalActionButton.onclick = levelUp;
                playSuccessSound(); // æ’­æ”¾å–®é—œæˆåŠŸéŸ³æ•ˆ
            }

            checkButton.disabled = true;
            successModalEl.classList.add('open');
            modalContentEl.classList.remove('scale-90');
            modalContentEl.classList.add('scale-100');
        }


        /** æª¢æŸ¥ç­”æ¡ˆä¸¦æä¾›åé¥‹ */
        function checkAnswer() {
            messageBoxEl.classList.remove('hidden');
            answerPanelEl.classList.remove('bg-red-200'); // æª¢æŸ¥å‰å…ˆç§»é™¤éŒ¯èª¤èƒŒæ™¯è‰²
            answerPanelEl.classList.add('bg-blue-50');

            let correctCount = 0;
            let allCorrect = true;

            for (let i = 0; i < challengeSequence.length; i++) {
                // æ‰¾åˆ°å°æ‡‰çš„ç›®æ¨™ç‰© (åŸºæ–¼ Emoji)
                const challengeEmoji = challengeSequence[i].emoji;
                // æ³¨æ„ï¼šé€™è£¡å¿…é ˆä½¿ç”¨ findï¼Œå› ç‚ºæˆ‘å€‘åœ¨ generateChallengeAndMapping ä¸­ç‚ºæ•¸å­¸é—œå¡æ·»åŠ äº†é¡å¤–çš„ mathLabel å±¬æ€§
                const correctItem = currentMapping.find(item => item.emoji === challengeEmoji);
                const correctHex = correctItem ? correctItem.correctHex : null;

                const userHex = userSelections[i];
                const circle = document.getElementById(`picker-circle-${i}`);
                const rowEl = document.getElementById(`input-row-${i}`);
                
                // é‡è¨­å–®è¡Œç‹€æ…‹
                circle.classList.remove('error', 'correct');
                rowEl.classList.remove('bg-red-300'); // ç§»é™¤å–®è¡ŒéŒ¯èª¤é¡è‰²
                rowEl.classList.add('bg-white'); // ç¢ºä¿å–®è¡Œé è¨­æ˜¯ç™½è‰²

                if (userHex === correctHex) {
                    correctCount++;
                    circle.classList.add('correct');
                    circle.classList.remove('error');
                } else {
                    allCorrect = false;
                    circle.classList.add('error');
                    circle.classList.remove('correct');
                    rowEl.classList.remove('bg-white'); // ç§»é™¤ç™½è‰²
                    rowEl.classList.add('bg-red-300'); // ä¿®æ­£ï¼šå°‡æ›´æ˜é¡¯çš„ç´…è‰²æ¨™ç¤ºåŠ åˆ°å–®è¡Œ
                }
            }

            if (allCorrect) {
                showSuccessModal();
            } else {
                // ç­”éŒ¯ - é¡¯ç¤ºåº•éƒ¨è¨Šæ¯ï¼Œä¸¦å°‡å³å´æ•´å€‹é¢æ¿çš„èƒŒæ™¯è®Šæˆæ›´æ·±çš„ç´…è‰²
                answerPanelEl.classList.remove('bg-blue-50');
                answerPanelEl.classList.add('bg-red-200'); // éŒ¯èª¤æ™‚ï¼Œå°‡æ•´å€‹å³å´é¢æ¿è®Šç‚ºè¼ƒæ·±çš„æ·ºç´…è‰²

                messageBoxEl.className = 'mt-6 p-4 text-center text-xl font-semibold rounded-lg border-2 bg-red-400 border-red-600 text-white'; // è¨Šæ¯æ¡†ä½¿ç”¨æ›´æ·±çš„ç´…ï¼Œç™½è‰²å­—
                messageBoxEl.textContent = `âŒ ç­”éŒ¯äº†ï¼æ‚¨ç­”å°äº† ${correctCount} é¡Œã€‚è«‹å†ä»”ç´°è§€å¯Ÿå·¦å´è¢«å¹²æ“¾çš„å ´æ™¯ï¼`;
            }
        }
        
        /** éš±è—ç ´é—œç•«é¢ä¸¦é‡æ–°åˆå§‹åŒ–éŠæˆ² */
        function closeSuccessModalAndInitGame() {
            successModalEl.classList.remove('open');
            modalContentEl.classList.remove('scale-100');
            modalContentEl.classList.add('scale-90');
            initGame();
        }
        
        /** é€²å…¥ä¸‹ä¸€é—œ */
        function levelUp() {
            if (currentLevel < (LEVEL_CONFIGS.length - 1)) {
                currentLevel++;
                closeSuccessModalAndInitGame();
            } else {
                // å¦‚æœå·²ç¶“æ˜¯æœ€å¾Œä¸€é—œï¼Œå‰‡é‡æ–°é–‹å§‹
                currentLevel = 1; 
                closeSuccessModalAndInitGame();
            }
        }
        
        /** é‡ç©æœ¬é—œ (Reset Button Handler) */
        function resetCurrentLevel() {
             closeSuccessModalAndInitGame();
        }
        
        /** é¡¯ç¤ºæ•…äº‹ Modal */
        function showStoryModal(level) {
            const config = LEVEL_CONFIGS[level];
            modalStoryTitleEl.textContent = `Level ${level}: ${config.title}`;
            modalStoryTextEl.textContent = config.story;
            storyModalEl.classList.add('open');
        }
        
        /** éš±è—æ•…äº‹ Modal */
        function hideStoryModal() {
            storyModalEl.classList.remove('open');
            // ç¢ºä¿åœæ­¢ä»»ä½•æ­£åœ¨æ’­æ”¾çš„ TTS
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
        }

        /** åˆå§‹åŒ–æˆ–é‡è¨­éŠæˆ² */
        function initGame() {
            if (currentLevel < 1) currentLevel = 1;
            if (currentLevel >= LEVEL_CONFIGS.length) currentLevel = 1; // å¾ªç’°å¾ç¬¬ä¸€é—œé–‹å§‹

            generateChallengeAndMapping(); 
            userSelections = challengeSequence.map(() => COLOR_OPTIONS[0].hex); 
            userColorIndex = challengeSequence.map(() => 0);
            
            // ç¦ç”¨äº’å‹•ç›´åˆ°æ•…äº‹ Modal é—œé–‰
            checkButton.disabled = true;
            resetButton.disabled = true;
            messageBoxEl.classList.add('hidden');
            
            successModalEl.classList.remove('open'); 
            
            // ç¢ºä¿é¢æ¿é¡è‰²æ­£ç¢º
            answerPanelEl.classList.remove('bg-red-200');
            answerPanelEl.classList.add('bg-blue-50');
            
            // æ¸²æŸ“ç•«é¢ï¼Œä½†å…ˆä¸é–‹æ”¾äº’å‹•
            renderSourceDisplay();
            renderChallengeInput();
            
            // é¡¯ç¤ºæ•…äº‹ Modal
            showStoryModal(currentLevel);

            console.log(`éŠæˆ²å·²åˆå§‹åŒ–è‡³é—œå¡ ${currentLevel}.`);
        }
        
        /** å•Ÿå‹•æŒ‘æˆ° (å¾æ•…äº‹ Modal é»æ“Šå¾Œè§¸ç™¼) */
        function startChallenge() {
            hideStoryModal();
            checkButton.disabled = false;
            resetButton.disabled = false;

            // åœ¨é¦–æ¬¡ç”¨æˆ¶äº’å‹•æ™‚ï¼Œå¼·åˆ¶å•Ÿå‹• Tone.js AudioContext
            try {
                Tone.start();
                console.log("Tone.js AudioContext started.");
            } catch (e) {
                console.error("Failed to start Tone.js AudioContext:", e);
            }
        }

        
        // ----------------------------------------------------
        // 5. äº‹ä»¶ç›£è½å™¨èˆ‡å•Ÿå‹•
        // ----------------------------------------------------

        checkButton.addEventListener('click', checkAnswer);
        resetButton.addEventListener('click', resetCurrentLevel);
        
        // æ•…äº‹ Modal çš„ TTS æŒ‰éˆ• (ä½¿ç”¨å…§å»º TTS)
        modalStoryTtsButton.addEventListener('click', () => {
             const story = modalStoryTextEl.textContent;
             if(story) readWord(story);
        });

        // å•Ÿå‹•æŒ‘æˆ°æŒ‰éˆ•
        startChallengeButton.addEventListener('click', startChallenge);
        
        // æˆåŠŸ Modal çš„ TTS æŒ‰éˆ• (æœ€çµ‚æ•…äº‹) (ä½¿ç”¨å…§å»º TTS)
        modalTtsButton.addEventListener('click', () => {
             const message = modalMessageEl.textContent;
             if (message) readWord(message);
        });

        // é¦–æ¬¡è¼‰å…¥éŠæˆ²
        window.onload = initGame;
    </script>
</body>
</html>